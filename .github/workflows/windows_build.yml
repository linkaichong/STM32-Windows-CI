# 工作流名称，明确标注Windows环境
name: STM32 Windows CI

# 触发条件
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-windows:
    # 关键修改：使用Windows运行器
    runs-on: windows-latest
    
    steps:
    # 步骤1：检出代码
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # 步骤2：在Windows上安装ARM GCC工具链
    - name: Install Official ARM GCC Toolchain (Latest)
      run: |
        # 下载ARM官方最新工具链（12.3版本）
        $TOOLCHAIN_VERSION = "12.3.rel1"
        # 最简单的下载和解压，不做任何额外操作
        $url = "https://developer.arm.com/-/media/Files/downloads/gnu/12.3.rel1/binrel/arm-gnu-toolchain-12.3.rel1-mingw-w64-i686-arm-none-eabi.zip"
        Invoke-WebRequest -Uri $url -OutFile toolchain.zip
        Expand-Archive -Path toolchain.zip -DestinationPath .
        
        # 只设置PATH，不做任何删除操作
        $path = (Get-Item "arm-gnu-toolchain-*/bin").FullName
        echo "$path" >> $env:GITHUB_PATH

    # 步骤3：安装CMake和Ninja（Windows版本）
    - name: Install CMake and Ninja
      run: |
        choco install cmake ninja -y --no-progress

    # 步骤4：验证工具链安装
    - name: Verify installations
      run: |
        echo "检查工具版本："
        arm-none-eabi-gcc --version
        cmake --version
        ninja --version

    # 步骤5：配置项目（注意Windows路径）
    - name: Configure project
      run: |
        # 在Windows上创建build目录并配置
        cmake -B build -G Ninja -DCMAKE_TOOLCHAIN_FILE=cmake/cortex_m3.cmake

    # 步骤6：编译项目
    - name: Build project
      run: |
        cmake --build build --verbose

    # 步骤7：验证构建产物（Windows路径）
    - name: Verify build artifacts
      run: |
        echo "生成的固件文件："
        dir build\*.elf build\*.bin build\*.hex 2>nul || echo "未找到文件"
        echo "文件信息："
        if exist build\*.elf ( arm-none-eabi-size build\*.elf )

    # 步骤8：上传构建产物
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: stm32-firmware-windows
        path: |
          build/*.elf
          build/*.bin
          build/*.hex
        retention-days: 7